---
title: "Execução Orçamentária: Análise do Valor Empenhado por Órgão"
output: github_document
---

Inclusão de pacotes

```{r setup,message=F}
library(tidyverse)
library(fs)
```

Checa tamanho dos arquivos

```{r}
dir_info("data") %>%
  select(path,size,modification_time)
```

# Leitura de Dados Higienizados

Colocar num data frame ("tibble"). Nota: arquivo agora 'e UTF-8

```{r df1,cache=T}
fname_2018_squished_zip <- "data/despesa2018_squished.zip"
df_orcamento <- read_delim(fname_2018_squished_zip,delim=";",
                           quote="'") # evita erro com "
glimpse(df_orcamento)
```

```{r}
problems(df_orcamento)
```

Quantas linhas, colunas, ou dimensões?

```{r}
# nrow(df_orcamento)
# ncol(df_orcamento)
dim(df_orcamento)
```

# Análise do "Empenho"

Calcula sumarização de colunas que parecem conter valores:

```{r,cache=T}
summary(df_orcamento%>%select(contains("empenh"),
                              contains("valor")))
```

Quantas linhas não preenchidas (com 'NA')?

```{r,cache=T}
df_orcamento$`Valor Empenhado` %>% is.na %>% sum
```

Plota histograma do Valor Empenhado

```{r,cache=T}
df_orcamento %>%
  transmute(valor_empenhado=(1+`Valor Empenhado`))%>%
  ggplot(aes(valor_empenhado)) +
  geom_histogram(bins=30,fill="blue",color="black") +
  scale_x_log10(breaks=10^(0:11),labels=c(1,10,100,
                                          "1k","10k" ,"100k" ,
                                          "1M","10M","100M",
                                          "1B","10B","100B"))+
  labs(title="Histograma de Valores Empenhados",
       subtitle="Ano 2018",
       x="Valor Empenhado (R$)")
```

# Estudo por Órgãos

Quantos por órgão?

```{r,cache=T}
df_orcamento %>%
  rename(orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  count(orgao_cod,orgao,sort=T)
```

Nomes de órgãos são únicos por código? Parece que há um problema no código 40

```{r,cache=T}
df_orcamento %>%
  rename(orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  count(orgao_cod,orgao) %>%
  count(orgao_cod,sort=T)
```

Quem é número 40 e em quais formas aparece?

```{r}
df_orcamento %>%
  rename(orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  count(orgao_cod,orgao) %>%
  filter(orgao_cod==40)
```

Empenho por órgão, harmonizando orgao_cod=40:

```{r}
df_orcamento %>%
  rename(valor_empenhado=`Valor Empenhado`,
         orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  mutate(orgao=if_else(orgao_cod==40,"Secretaria de Estado de Ciência Tecnologia",orgao)) %>%
  group_by(orgao) %>%
  summarize(n=n(),
            total=sum(valor_empenhado),
            media=mean(valor_empenhado),
            mediana=median(valor_empenhado),
            desvio_padrao=sd(valor_empenhado),
            mad=mad(valor_empenhado)) %>%
  mutate_at(vars(-orgao,-n),~(./10^6)%>%as.integer) %>%
  arrange(-total)
```

Remove prefixos de nomes de órgãos

```{r}
clean_orgao <- function(orgao) orgao %>%
  str_remove("^Secretaria d[aeo] Estado d[aeo] ")
```

Empenho total por órgão: Top 5

```{r}
df_orcamento %>%
  rename(valor_empenhado=`Valor Empenhado`,
         orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  mutate(orgao=if_else(orgao_cod==40,"Secretaria de Estado de Ciência Tecnologia",orgao),
         orgao=orgao%>%clean_orgao,
         orgao=orgao%>%fct_reorder(-valor_empenhado,sum)) %>%
  filter(as.integer(orgao)<6) %>%
  mutate(orgao=orgao%>%fct_rev) %>%
  group_by(orgao) %>%
  summarize(total=sum(valor_empenhado)/10^9) %>%
  ggplot(aes(orgao,total)) +
  geom_col(aes(fill=orgao)) +
  coord_flip() +
  labs(title="Valor Empenhado Total por Órgão",
       subtitle="Ano 2018, Top 5",
       y="Valor Empenhado Total (R$ bilhões)") +
  theme(legend.position = "none",
        axis.title.y=element_blank())
```

Distribuição do Empenho por Órgão (boxbplot)

```{r}
df_orcamento %>%
  rename(valor_empenhado=`Valor Empenhado`,
         orgao_cod=`Órgão`,
         orgao=`Nome Órgão`) %>%
  mutate(orgao=if_else(orgao_cod==40,"Secretaria de Estado de Ciência Tecnologia",orgao),
         orgao=orgao%>%clean_orgao,
         orgao=orgao%>%fct_reorder(valor_empenhado+1,.fun=median,.desc=T)) %>%
  filter(as.integer(orgao)<6) %>%
  mutate(orgao=orgao%>%fct_rev) %>% # for coord_flip
  ggplot(aes(orgao,valor_empenhado+1)) +
  geom_boxplot(aes(fill=orgao),notch=T) +
  scale_y_log10(breaks=10^c(3,6,9),labels=c("1k","1M","1B"))+
  coord_flip() +
  labs(title="Distribuição dos Valores Empenhados por Órgão",
       subtitle="Ano 2018, Top 5 medianas",
       y="Valor Empenhado (R$)") +
  theme(legend.position = "none",
        axis.title.y=element_blank())
```

