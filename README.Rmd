---
title: "Projeto 1: Execução Orçamentária"
output: github_document
---

```{r,eval=T,echo=F}
knitr::include_graphics("pics/transparencia_fiscal.png")
```

* Fonte: [Portal de Transparência Fiscal](http://www.transparencia.rj.gov.br/transparencia/faces/OrcamentoTematico/despesa)
* Estudo exploratório:
    + Quais "pastas" estão sendo mais pagas
    + Quais modalidades de licitação
    + Com qual frequência de dispensa
    + Por áreas de governo, etc.
* Pasta de Saúde:
    + Esta pasta recebe menos recursos do que as demais
    + Comparar com gastos em outras áreas

# Preparo dos Dados

Inclusão de pacotes

```{r setup,message=F}
library(tidyverse)
library(fs)
```

Lista diretório

```{r}
dir_ls("data")
```

Unzipa o original

```{r,eval=F}
unzip("data/despesa2018.zip",exdir='data')
```

Cria variável com nome do arquivo e conta linhas

```{r,cache=T}
fname_2018 <- "data/despesa2018.csv"
linhas <- read_file(fname_2018) %>% str_count('\\n')
linhas
```

Olhar para as primeiras linhas

```{r inspect,cache=T}
read_lines(fname_2018, n_max=10)
```

Qual é o encoding deste arquivo?

```{r,cache=T}
guess_encoding(fname_2018)
```

Data Cleansing: Pular 5 linhas no cabeçalho, ajustar o "encoding"

```{r tratar1,cache=T}
loc_bz <- locale(encoding="ISO-8859-1")
primeiras_linhas <- read_lines(fname_2018, # .zip
                               skip=5,n_max=5,
                               locale=loc_bz)
primeiras_linhas
```

Remover espaços. Referencia de [REGEXP](https://stringr.tidyverse.org/articles/regular-expressions.html)

```{r}
remove_espacos <- function(s) s %>% # 'pipe' do pacote "magrittr"
  str_remove_all("\\s+(?=;)") %>%
  str_remove_all("\\s+$") %>%
  str_replace_all("\\s+"," ")
```

Testar nas primeiras linhas

```{r}
primeiras_linhas %>% remove_espacos
```

Compara tamanho antes do "squish" e depois

```{r,cache=T}
primeiras_linhas %>% str_length %>% sum
primeiras_linhas %>% remove_espacos %>% str_length %>% sum
```

Olhando pro fim do arquivo

```{r,cache=T}
# BUGADO
# read_lines(fname_2018,skip=linhas-10,locale=loc_bz)
str_2018 <- read_lines(fname_2018,skip=5,
                            locale=loc_bz)
str_length(str_2018) %>% sum
```

Remove espaços de todas as linhas

```{r,cache=T}
str_2018_squished <- str_2018 %>% remove_espacos
rm(str_2018)
str_2018_squished %>% str_length %>% sum
```

Salva arquivo enxuto em novo csv

```{r}
fname_2018_squished <- "data/despesa2018_squished.csv"
```

```{r,eval=F}
fname_2018_squished <- "data/despesa2018_squished.csv"
str_2018_squished %>% write_lines(fname_2018_squished)
rm(str_2018_squished)
```

Zipa o resultado

```{r,cache=T}
repl_ext <- function(s,new_ext) s %>%
  str_replace_all("(?<=\\.).+$",new_ext)
fname_2018_squished_zip <- repl_ext(fname_2018_squished,"zip")
zip::zip(fname_2018_squished_zip,fname_2018_squished)
```

Checa se encoding está ok

```{r,cache=T}
guess_encoding(fname_2018_squished_zip)
```

Checa tamanho dos arquivos

```{r}
dir_info("data") %>% select(path,size,modification_time)
```

# Leitura de Dados Higienizados

Colocar num data frame ("tibble"). Nota: arquivo agora 'e UTF-8

```{r df1,cache=T}
df_orcamento <- read_delim(fname_2018_squished_zip,delim=";")
df_orcamento
```

Quantas linhas, colunas, ou dimensões?

```{r}
nrow(df_orcamento)
ncol(df_orcamento)
dim(df_orcamento)
```

Examinando data frame verticalmente
```{r}
glimpse(df_orcamento)
```

# Análise do "Empenho"

Parece que empenho é 'valor'. Calcula estatística summarizada:

```{r,cache=T}
summary(df_orcamento$Empenho)
```

Quantos não preenchidos?

```{r,cache=T}
df_orcamento$Empenho %>% is.na %>% sum
```

Plota histograma do Empenho

```{r.cache=T}
df_orcamento %>% ggplot(aes(Empenho)) +
  geom_histogram(bins=30,fill="blue",color="black")
```

Aplica "log" no valor:

```{r,cache=T}
df_orcamento %>% ggplot(aes(Empenho)) +
  geom_histogram(bins=30,fill="blue",color="black") +
  scale_x_log10()
```

Estudo dos Órgãos

```{r,cache=T}
df_orcamento %>% count(`Órgão`,`Nome Órgão`)
```

Ordenando pelo mais frequente

```{r,cache=T}
df_orcamento %>% count(`Órgão`,`Nome Órgão`,sort=T)
```

Empenho médio por órgão:

```{r,cache=T}
df_orcamento %>%
  group_by(`Nome Órgão`) %>%
  summarize(n=n(),medio=mean(Empenho),mediano=median(Empenho),desvio_padrao=sd(Empenho)) %>%
  arrange(-medio)
```

Mostra como boxbplot

```{r,cache=T}
df_orcamento %>%
  rename(orgao=`Nome Órgão`) %>%
  mutate(orgao=orgao%>%fct_reorder(-Empenho)) %>%
  filter(as.integer(orgao)<6) %>%
  mutate(orgao=orgao%>%fct_rev) %>%
  ggplot(aes(orgao,Empenho)) +
  geom_boxplot(aes(fill=orgao)) +
  #scale_y_log10(trans="reverse") +
  coord_flip() +
  scale_y_continuous(trans="log10") +
  labs(title="Maiores Empenhos Medianos por Órgão",
       subtitle="Ano 2018") +
  theme(legend.position = "none",
        axis.title.y=element_blank())
```

